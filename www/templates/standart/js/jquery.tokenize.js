/**
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * This software consists of voluntary contributions made by many individuals
 * and is licensed under the new BSD license.
 *
 * @author      David Zeller <me@zellerda.com>
 * @license     http://www.opensource.org/licenses/BSD-3-Clause New BSD license
 * @version     2.6
 */
!function(t,e){var n={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,ARROW_UP:38,ARROW_DOWN:40},o=null,i="tokenize",s=function(e,n){if(!n.data(i)){var o=new t.tokenize(t.extend({},t.fn.tokenize.defaults,e));n.data(i,o),o.init(n)}return n.data(i)};t.tokenize=function(e){void 0==e&&(e=t.fn.tokenize.defaults),this.options=e},t.extend(t.tokenize.prototype,{init:function(e){var n=this;this.select=e.attr("multiple","multiple").css({margin:0,padding:0,border:0}).hide(),this.container=t("<div />").attr("class",this.select.attr("class")).addClass("Tokenize"),1==this.options.maxElements&&this.container.addClass("OnlyOne"),this.dropdown=t("<ul />").addClass("Dropdown"),this.tokensContainer=t("<ul />").addClass("TokensContainer"),this.options.autosize&&this.tokensContainer.addClass("Autosize"),this.searchToken=t("<li />").addClass("TokenSearch").appendTo(this.tokensContainer),this.searchInput=t("<input />").appendTo(this.searchToken),this.options.searchMaxLength>0&&this.searchInput.attr("maxlength",this.options.searchMaxLength),this.select.prop("disabled")&&this.disable(),this.options.sortable&&("undefined"!=typeof t.ui?this.tokensContainer.sortable({items:"li.Token",cursor:"move",placeholder:"Token MovingShadow",forcePlaceholderSize:!0,update:function(){n.updateOrder()},start:function(){n.searchToken.hide()},stop:function(){n.searchToken.show()}}).disableSelection():(this.options.sortable=!1,console.error("jQuery UI is not loaded, sortable option has been disabled"))),this.container.append(this.tokensContainer).append(this.dropdown).insertAfter(this.select),this.tokensContainer.on("click",function(e){e.stopImmediatePropagation(),n.searchInput.get(0).focus(),n.updatePlaceholder(),n.dropdown.is(":hidden")&&(""!=n.searchInput.val()||[4,14,17,16,13].indexOf(parseInt(t("#cri_type").val()))!=-1)&&n.search()}),this.searchInput.on("blur",function(){n.tokensContainer.removeClass("Focused")}),this.searchInput.on("focus click",function(){n.tokensContainer.addClass("Focused"),n.options.displayDropdownOnFocus&&"select"==n.options.datas&&n.search()}),this.searchInput.on("keydown",function(t){n.resizeSearchInput(),n.keydown(t)}),this.searchInput.on("keyup",function(t){n.keyup(t)}),this.searchInput.on("keypress",function(t){n.keypress(t)}),this.searchInput.on("paste",function(){setTimeout(function(){n.resizeSearchInput()},10),setTimeout(function(){var e=[];e=Array.isArray(n.options.delimiter)?n.searchInput.val().split(new RegExp(n.options.delimiter.join("|"),"g")):n.searchInput.val().split(n.options.delimiter),e.length>1&&t.each(e,function(t,e){n.tokenAdd(e.trim(),"")})},20)}),t(document).on("click",function(){n.dropdownHide(),1==n.options.maxElements&&n.searchInput.val()&&n.tokenAdd(n.searchInput.val(),"")}),this.resizeSearchInput(),this.remap(!0),this.updatePlaceholder()},updateOrder:function(){if(this.options.sortable){var e,n,o=this;t.each(this.tokensContainer.sortable("toArray",{attribute:"data-value"}),function(i,s){n=t('option[value="'+s+'"]',o.select),void 0==e?n.prependTo(o.select):e.after(n),e=n}),this.options.onReorder(this)}},updatePlaceholder:function(){this.options.placeholder&&(void 0==this.placeholder&&(this.placeholder=t("<li />").addClass("Placeholder").html(this.options.placeholder),this.placeholder.insertBefore(t("li:first-child",this.tokensContainer))),0==this.searchInput.val().length&&0==t("li.Token",this.tokensContainer).length?this.placeholder.show():this.placeholder.hide())},number_rows_in_scroll:12,first_row_number:1,last_row_number:12,dropdownShow:function(){this.dropdown.show(),this.options.onDropdownShow(this),this.first_row_number=1,this.last_row_number=12,t(".Dropdown").scrollTop(0)},dropdownPrev:function(){t("li.Hover",this.dropdown).length>0&&(t("li.Hover",this.dropdown).is("li:first-child")||t("li.Hover",this.dropdown).removeClass("Hover").prev().addClass("Hover")),t("li.Hover").attr("data-number")<this.first_row_number&&(t(".Dropdown").scrollTop(t(".Dropdown").scrollTop()-25),this.last_row_number-=1,this.first_row_number-=1)},dropdownNext:function(){t("li.Hover",this.dropdown).length>0&&(t("li.Hover",this.dropdown).is("li:last-child")||t("li.Hover",this.dropdown).removeClass("Hover").next().addClass("Hover")),t("li.Hover").attr("data-number")>this.last_row_number&&(t(".Dropdown").scrollTop(t(".Dropdown").scrollTop()+25),this.last_row_number+=1,this.first_row_number+=1)},dropdownAddItem:function(e,n,o,i){if(o=o||n,!t('li[data-value="'+e+'"]',this.tokensContainer).length){var s=this,r=t("<li />").attr("data-value",e).attr("data-text",n).attr("data-number",i).html(o).on("click",function(e){e.stopImmediatePropagation(),s.tokenAdd(t(this).attr("data-value"),t(this).attr("data-text"))}).on("mouseenter",function(){t("li.Hover").removeClass("Hover"),t(this).addClass("Hover")}).on("mouseleave",function(){t("li",s.dropdown).removeClass("Hover")});this.dropdown.append(r),this.options.onDropdownAddItem(e,n,o,this)}return this},dropdownHide:function(){this.dropdownReset(),this.dropdown.hide()},dropdownReset:function(){this.dropdown.html("")},resizeSearchInput:function(){this.searchInput.attr("size",Number(this.searchInput.val().length)+5),this.updatePlaceholder()},resetSearchInput:function(){this.searchInput.val(""),this.resizeSearchInput()},resetPendingTokens:function(){t("li.PendingDelete",this.tokensContainer).removeClass("PendingDelete")},keypress:function(t){var e=!1;Array.isArray(this.options.delimiter)?this.options.delimiter.indexOf(String.fromCharCode(t.which))>=0&&(e=!0):String.fromCharCode(t.which)==this.options.delimiter&&(e=!0),e&&(t.preventDefault(),this.tokenAdd(this.searchInput.val(),""))},keydown:function(e){switch(e.keyCode){case n.BACKSPACE:0==this.searchInput.val().length&&(e.preventDefault(),t("li.Token.PendingDelete",this.tokensContainer).length?this.tokenRemove(t("li.Token.PendingDelete").attr("data-value")):t("li.Token:last",this.tokensContainer).addClass("PendingDelete"),this.dropdownHide());break;case n.TAB:case n.ENTER:if(t("li.Hover",this.dropdown).length){var o=t("li.Hover",this.dropdown);e.preventDefault(),this.tokenAdd(o.attr("data-value"),o.attr("data-text"))}else this.searchInput.val()&&(e.preventDefault(),this.tokenAdd(this.searchInput.val(),""));this.resetPendingTokens();break;case n.ESCAPE:this.resetSearchInput(),this.dropdownHide(),this.resetPendingTokens();break;case n.ARROW_UP:e.preventDefault(),this.dropdownPrev();break;case n.ARROW_DOWN:e.preventDefault(),this.dropdownNext();break;default:this.resetPendingTokens()}},keyup:function(e){switch(this.updatePlaceholder(),e.keyCode){case n.TAB:case n.ENTER:case n.ESCAPE:case n.ARROW_UP:case n.ARROW_DOWN:break;case n.BACKSPACE:this.searchInput.val()||[14,17,16].indexOf(-1!=parseInt(t("#cri_type").val()))?this.search():this.dropdownHide();break;default:(this.searchInput.val()||[14,17,16].indexOf(-1!=parseInt(t("#cri_type").val())))&&this.search()}},search:function(){var e=this,n=1;if(this.options.maxElements>0&&t("li.Token",this.tokensContainer).length>=this.options.maxElements||this.searchInput.val().length<this.options.searchMinLength)return!1;if("select"==this.options.datas){var o=!1,i=new RegExp(this.searchInput.val().replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),"i");this.dropdownReset(),t("option",this.select).not(":selected, :disabled").each(function(){return n<=e.options.nbDropdownElements?void(i.test(t(this).html())&&(e.dropdownAddItem(t(this).attr("value"),t(this).html()),o=!0,n++)):!1}),o?(t("li:first",this.dropdown).addClass("Hover"),this.dropdownShow()):this.dropdownHide()}else this.debounce(function(){this.ajax&&this.ajax.abort(),this.ajax=t.ajax({url:e.options.datas,type:"POST",data:{type:"load_cri_options",string:encodeURIComponent(e.searchInput.val()),cri_option:t("#cri_type").val(),ajax:1},dataType:e.options.dataType,success:function(o){if(o){e.dropdownReset();var i=0;if(t.each(o,function(t,o){if(!(n<=e.options.nbDropdownElements))return!1;var s;o[e.options.htmlField]&&(s=o[e.options.htmlField]),e.dropdownAddItem(o[e.options.valueField],o[e.options.textField],s,++i),n++}),t("li",e.dropdown).length)return t("li:first",e.dropdown).addClass("Hover"),e.dropdownShow(),!0}e.dropdownHide()},error:function(t,n){e.options.onAjaxError(e,t,n)}})},this.options.debounce)},debounce:function(t,e){var n=this,i=arguments,s=function(){t.apply(n,i),o=null};o&&clearTimeout(o),o=setTimeout(s,e||this.options.debounce)},tokenAdd:function(e,n,o){if(e=this.escape(e).trim(),void 0==e||""==e)return this;if(n=n||e,o=o||!1,this.options.maxElements>0&&t("li.Token",this.tokensContainer).length>=this.options.maxElements)return this.resetSearchInput(),this;var i=this,s=t("<a />").addClass("Close").html("&#215;").on("click",function(t){t.stopImmediatePropagation(),i.tokenRemove(e)});if(t('option[value="'+e+'"]',this.select).length)o||t('option[value="'+e+'"]',this.select).attr("selected")!==!0&&t('option[value="'+e+'"]',this.select).prop("selected")!==!0||this.options.onDuplicateToken(e,n,this),t('option[value="'+e+'"]',this.select).attr("selected",!0).prop("selected",!0);else{if(!(this.options.newElements||!this.options.newElements&&t('li[data-value="'+e+'"]',this.dropdown).length>0))return this.resetSearchInput(),this;var r=t("<option />").attr("selected",!0).attr("value",e).attr("data-type","custom").prop("selected",!0).html(n);this.select.append(r)}return t('li.Token[data-value="'+e+'"]',this.tokensContainer).length>0?this:(t("<li />").addClass("Token").attr("data-value",e).append("<span>"+n+"</span>").prepend(s).insertBefore(this.searchToken),o||this.options.onAddToken(e,n,this),this.resetSearchInput(),this.dropdownHide(),this.updateOrder(),this)},tokenRemove:function(e){var n=t("li.Token");return n.each(function(n,o){o.getAttribute("data-value")==e&&t(o,this.tokensContainer).remove()}),this.options.onRemoveToken(e,this),this.resizeSearchInput(),this.dropdownHide(),this.updateOrder(),this},clear:function(){var e=this;return t("li.Token",this.tokensContainer).each(function(){e.tokenRemove(t(this).attr("data-value"))}),this.options.onClear(this),this.dropdownHide(),this},disable:function(){return this.select.prop("disabled",!0),this.searchInput.prop("disabled",!0),this.container.addClass("Disabled"),this.container.css("display","none"),this.options.sortable&&this.tokensContainer.sortable("disable"),this},enable:function(){return this.select.prop("disabled",!1),this.searchInput.prop("disabled",!1),this.container.removeClass("Disabled"),this.container.css("display","block"),this.options.sortable&&this.tokensContainer.sortable("enable"),this},remap:function(e){var n=this,o=t("option:selected",this.select);return e=e||!1,this.clear(),o.each(function(){n.tokenAdd(t(this).val(),t(this).html(),e)}),this},toArray:function(){var e=[];return t("option:selected",this.select).each(function(){e.push(t(this).val())}),e},escape:function(t){var e=document.createElement("div");return e.innerHTML=t,t=e.textContent||e.innerText||"",String(t).replace(/["]/g,function(){return""})}}),t.fn.tokenize=function(e){e=e||{};var n=this.filter("select");if(n.length>1){var o=[];return n.each(function(){o.push(s(e,t(this)))}),o}return s(e,t(this))},t.fn.tokenize.defaults={datas:"select",placeholder:!1,searchParam:"search",searchMaxLength:0,searchMinLength:0,debounce:0,delimiter:",",newElements:!0,autosize:!1,nbDropdownElements:10,displayDropdownOnFocus:!1,maxElements:0,sortable:!1,dataType:"json",valueField:"value",textField:"text",htmlField:"html",onAddToken:function(t,e,n){},onRemoveToken:function(t,e){},onClear:function(t){},onReorder:function(t){},onDropdownAddItem:function(t,e,n,o){},onDropdownShow:function(t){},onDuplicateToken:function(t,e,n){},onAjaxError:function(t,e,n){}}}(jQuery,"tokenize");